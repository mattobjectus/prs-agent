<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" href="/images/favicon-32x32.png" />
        <title>PRS Expert</title>
        <link rel="stylesheet" href="/css/chat.css" />
    </head>
    <body>
        <div class="chat-container">
            <div class="chat-header">
                <img src="/images/prs-logo.png" alt="PRS Logo" />
                <span>Knowledge Agent</span>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message agent">
                    <div class="message-bubble">Hello! I'm your PRS knowledge agent. What would you like to know?</div>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="input-container">
                    <input type="text" id="messageInput" placeholder="Type your message here..." autocomplete="off" />
                    <button id="sendButton">Send</button>
                </div>
                <div class="audio-controls">
                    <button id="muteButton" class="control-button" title="Mute/Unmute">ðŸŽ¤</button>
                    <input
                        type="range"
                        id="volumeSlider"
                        min="0"
                        max="100"
                        value="80"
                        class="volume-slider"
                        title="Volume"
                    />
                </div>
            </div>
        </div>

        <script>
            // Generate a unique session ID for this browser session
            let sessionId = sessionStorage.getItem("chatSessionId");
            if (!sessionId) {
                sessionId = "session-" + Date.now() + "-" + Math.random().toString(36).substring(2, 9);
                sessionStorage.setItem("chatSessionId", sessionId);
            }

            const chatMessages = document.getElementById("chatMessages");
            const messageInput = document.getElementById("messageInput");
            const sendButton = document.getElementById("sendButton");
            const muteButton = document.getElementById("muteButton");
            const volumeSlider = document.getElementById("volumeSlider");

            // Text-to-Speech setup
            let isMuted = false;
            let currentVolume = 0.8; // 80% volume by default

            // Initialize Web Speech API
            const synth = window.speechSynthesis;

            function stripHtmlTags(html) {
                const tmp = document.createElement("DIV");
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || "";
            }

            function speakText(text) {
                if (isMuted || !synth) return;

                // Cancel any ongoing speech
                synth.cancel();

                // Strip HTML tags from text
                const cleanText = stripHtmlTags(text);

                if (!cleanText.trim()) return;

                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.volume = currentVolume;
                utterance.rate = 0.95; // Slightly slower for clarity
                utterance.pitch = 1.15; // Higher pitch for friendlier tone

                synth.speak(utterance);
            }

            // Mute button handler
            muteButton.addEventListener("click", () => {
                isMuted = !isMuted;
                muteButton.textContent = isMuted ? "ðŸ”‡" : "ðŸŽ¤";

                // Cancel any ongoing speech when muting
                if (isMuted && synth) {
                    synth.cancel();
                }
            });

            // Volume slider handler - updates volume in real-time without interruption
            volumeSlider.addEventListener("input", (e) => {
                currentVolume = e.target.value / 100;

                // Update volume on currently playing utterance if any
                if (synth && synth.speaking) {
                    // Note: Volume changes apply to next speech, can't change current utterance mid-play
                    // This is a browser limitation of Web Speech API
                }
            });

            function addMessage(text, isUser) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${isUser ? "user" : "agent"}`;
                const thetop = chatMessages.scrollHeight;
                if (text.includes("<html")) {
                    let htmlT = text.substring(text.indexOf("<html"), text.indexOf("</html")) + "</html>";
                    const bubbleDiv = document.createElement("div");
                    bubbleDiv.className = "message-bubble";
                    bubbleDiv.innerHTML = htmlT;
                    messageDiv.appendChild(bubbleDiv);
                } else if (text.trim().startsWith("<")) {
                    text = text.trim();
                    const bubbleDiv = document.createElement("div");
                    bubbleDiv.className = "message-bubble";
                    bubbleDiv.innerHTML = text;
                    messageDiv.appendChild(bubbleDiv);
                } else {
                    const bubbleDiv = document.createElement("div");
                    bubbleDiv.className = "message-bubble";
                    bubbleDiv.textContent = text;
                    messageDiv.appendChild(bubbleDiv);
                }

                chatMessages.appendChild(messageDiv);

                // Scroll to bottom
                chatMessages.scrollTop = thetop;

                // Speak agent responses
                if (!isUser) {
                    speakText(text);
                }
            }

            function addLoadingIndicator() {
                const messageDiv = document.createElement("div");
                messageDiv.className = "message agent";
                messageDiv.id = "loading-indicator";

                const bubbleDiv = document.createElement("div");
                bubbleDiv.className = "message-bubble";

                const loadingDiv = document.createElement("div");
                loadingDiv.className = "loading";
                loadingDiv.innerHTML = "<span></span><span></span><span></span>";

                bubbleDiv.appendChild(loadingDiv);
                messageDiv.appendChild(bubbleDiv);
                chatMessages.appendChild(messageDiv);

                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function removeLoadingIndicator() {
                const loadingIndicator = document.getElementById("loading-indicator");
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            }

            async function sendMessage() {
                const userMessage = messageInput.value.trim();

                if (!userMessage) {
                    return;
                }

                // Add user message to chat
                addMessage(userMessage, true);

                // Clear input and disable send button
                messageInput.value = "";
                sendButton.disabled = true;
                messageInput.disabled = true;

                // Show loading indicator
                addLoadingIndicator();

                try {
                    const response = await fetch(`/prsKnowledgeAgent?userMessage=${encodeURIComponent(userMessage)}`);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const agentResponse = await response.text();

                    // Remove loading indicator
                    removeLoadingIndicator();

                    // Add agent response to chat
                    addMessage(agentResponse, false);
                } catch (error) {
                    console.error("Error calling prs knowledge agent:", error);
                    removeLoadingIndicator();
                    addMessage("Sorry, I encountered an error. Please try again.", false);
                } finally {
                    // Re-enable send button and input
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }

            // Send message on button click
            sendButton.addEventListener("click", sendMessage);

            // Send message on Enter key
            messageInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    sendMessage();
                }
            });

            // Focus input on load
            messageInput.focus();
        </script>
    </body>
</html>
